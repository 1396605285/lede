name: ç¼–è¯‘ ffmpegï¼ˆarmv7 A5 + H.264ï¼‰
on:
  push:
    branches: [ main ]  # æ¨é€ä»£ç åˆ°ä½  fork ä»“åº“çš„ main åˆ†æ”¯è‡ªåŠ¨è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆActions é¡µé¢ç‚¹ã€ŒRun workflowã€ï¼‰

jobs:
  compile-ffmpeg:
    runs-on: ubuntu-22.04
    env:
      # å…¨å±€è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå…è®¸ root ç¼–è¯‘ï¼ˆè§£å†³ tar/gperf ç­‰å·¥å…·çš„æŠ¥é”™ï¼‰
      FORCE_UNSAFE_CONFIGURE: 1
    steps:
      ###########################################################################
      # æ­¥éª¤ 1ï¼šæ‹‰å–ã€Œä½ è‡ªå·± fork çš„ LEDE ä»“åº“ã€ï¼ˆè‡ªå¸¦ä½ çš„ .configï¼‰
      ###########################################################################
      - name: æ‹‰å–è‡ªå·± fork çš„ LEDE æºç 
        uses: actions/checkout@v4
        with:
          repository: 1396605285/lede  # ğŸ‘‰ å¿…é¡»æ”¹ï¼šæ›¿æ¢ä¸ºä½ çš„ fork ä»“åº“åœ°å€ï¼ˆæ¯”å¦‚ user/ledeï¼‰
          fetch-depth: 1  # åªæ‹‰æœ€æ–°ä»£ç ï¼ŒåŠ é€Ÿ



      ###########################################################################
      # æ­¥éª¤ 3ï¼šå®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆä¸å˜ï¼‰
      ###########################################################################
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
          genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
          libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
          python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
          swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev


            # æ–°å¢æ­¥éª¤ï¼šæ¸…ç† feeds ç¼“å­˜
      - name: æ¸…ç† feeds ç¼“å­˜ï¼ˆé‡æ–°åŒæ­¥ï¼‰
        run: |
          rm -rf feeds/packages/* feeds/luci/* feeds/custom/*
          ./scripts/feeds clean

# ä¿®æ”¹æ­¥éª¤ï¼šæ›´æ–°å¹¶å®‰è£… feedsï¼ˆåŠ æ—¥å¿—ï¼‰
      - name: æ›´æ–°å¹¶å®‰è£… feedsï¼ˆæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼‰
        run: |
          ./scripts/feeds update -a V=s
          ./scripts/feeds install -a V=s


          make download -j1 V=s

      ###########################################################################
      # æ­¥éª¤ 7ï¼šå•ç‹¬ç¼–è¯‘ ffmpegï¼ˆä¸å˜ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘ ffmpegï¼ˆarmv7 A5 + H.264ï¼‰
        run: |
          # æ¸…ç†ç¼“å­˜
          make package/ffmpeg/clean
          make toolchain/install V=sc -j2

          
          # ç¼–è¯‘ ffmpegï¼ˆ-j2 é€‚é… Actions å…è´¹ç‰ˆ CPUï¼‰
          make package/ffmpeg/compile V=s -j2

      ###########################################################################
      # å…³é”®ï¼šæ‰“åŒ…æ•´ä¸ª bin/packages/ ç›®å½•
      ###########################################################################
      - name: ä¸Šä¼ æ•´ä¸ª packages ç›®å½•ï¼ˆå«æ‰€æœ‰ .ipkï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-packages-full-24.10
          path: bin/packages/  # ç›´æ¥æ‰“åŒ…æ•´ä¸ªç›®å½•ï¼Œæ— éœ€çº ç»“å­è·¯å¾„
          retention-days: 30
          if-no-files-found: error  # æ²¡æ‰¾åˆ°ç›®å½•æ—¶æŠ¥é”™ï¼Œæ–¹ä¾¿æ’æŸ¥
