name: ç¼–è¯‘ ffmpegï¼ˆarmv7 A5 + H.264ï¼‰
on:
  push:
    branches: [ main ]  # æ¨é€ä»£ç åˆ°ä½  fork ä»“åº“çš„ main åˆ†æ”¯è‡ªåŠ¨è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆActions é¡µé¢ç‚¹ã€ŒRun workflowã€ï¼‰

jobs:
  compile-ffmpeg:
    runs-on: ubuntu-22.04
    steps:
      ###########################################################################
      # æ­¥éª¤ 1ï¼šæ‹‰å–ã€Œä½ è‡ªå·± fork çš„ LEDE ä»“åº“ã€ï¼ˆè‡ªå¸¦ä½ çš„ .configï¼‰
      ###########################################################################
      - name: æ‹‰å–è‡ªå·± fork çš„ LEDE æºç 
        uses: actions/checkout@v4
        with:
          repository: 1396605285/lede  # ğŸ‘‰ å¿…é¡»æ”¹ï¼šæ›¿æ¢ä¸ºä½ çš„ fork ä»“åº“åœ°å€ï¼ˆæ¯”å¦‚ user/ledeï¼‰
          fetch-depth: 1  # åªæ‹‰æœ€æ–°ä»£ç ï¼ŒåŠ é€Ÿ

      ###########################################################################
      # æ­¥éª¤ 2ï¼šå¤åˆ¶ .config åˆ°ä»“åº“æ ¹ç›®å½•ï¼ˆfork ä»“åº“å†…ç›´æ¥æ‰¾ï¼Œæ— è·¯å¾„é—®é¢˜ï¼‰
      ###########################################################################
      - name: åŠ è½½è‡ªå®šä¹‰ .config é…ç½®
        run: |
          # éªŒè¯ .config æ˜¯å¦å­˜åœ¨ï¼ˆè¾“å‡ºæ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥ï¼‰
          echo "=== æŸ¥çœ‹ fork ä»“åº“çš„ configs æ–‡ä»¶å¤¹ ==="
          ls -la configs/
          
          # ç›´æ¥å¤åˆ¶ä½ ä¸Šä¼ çš„ .config åˆ°ä»“åº“æ ¹ç›®å½•ï¼ˆ.config æ˜¯ LEDE ç¼–è¯‘çš„é»˜è®¤é…ç½®æ–‡ä»¶ï¼‰
          if [ -f "configs/armv7-a5-ffmpeg.config" ]; then
            cp configs/armv7-a5-ffmpeg.config .config
            echo "âœ… æˆåŠŸåŠ è½½ .configï¼Œé…ç½®é¢„è§ˆï¼š"
            head -10 .config  # è¾“å‡ºå‰ 10 è¡Œï¼Œç¡®è®¤æ¶æ„é…ç½®æ­£ç¡®
          else
            echo "âŒ æ‰¾ä¸åˆ° configs/armv7-a5-ffmpeg.configï¼"
            exit 1
          fi

      ###########################################################################
      # æ­¥éª¤ 3ï¼šå®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆä¸å˜ï¼‰
      ###########################################################################
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y && sudo apt full-upgrade -y
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
          genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
          libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
          python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
          swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev


            # æ–°å¢æ­¥éª¤ï¼šæ¸…ç† feeds ç¼“å­˜
      - name: æ¸…ç† feeds ç¼“å­˜ï¼ˆé‡æ–°åŒæ­¥ï¼‰
        run: |
          rm -rf feeds/packages/* feeds/luci/* feeds/custom/*
          ./scripts/feeds clean

# ä¿®æ”¹æ­¥éª¤ï¼šæ›´æ–°å¹¶å®‰è£… feedsï¼ˆåŠ æ—¥å¿—ï¼‰
      - name: æ›´æ–°å¹¶å®‰è£… feedsï¼ˆæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼‰
        run: |
          ./scripts/feeds update -a V=s
          ./scripts/feeds install -a V=s


      ###########################################################################
      # æ­¥éª¤ 6ï¼šé¢„ä¸‹è½½ä¾èµ–åŒ…ï¼ˆä¸å˜ï¼‰
      ###########################################################################
      - name: ä¸‹è½½ ffmpeg ä¾èµ–åŒ…
        run: |
          make download -j1 V=s

      ###########################################################################
      # æ­¥éª¤ 7ï¼šå•ç‹¬ç¼–è¯‘ ffmpegï¼ˆä¸å˜ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘ ffmpegï¼ˆarmv7 A5 + H.264ï¼‰
        run: |
          # æ¸…ç†ç¼“å­˜
          make package/libx264/clean
          make package/ffmpeg/clean
          
          # ç¼–è¯‘ ffmpegï¼ˆ-j2 é€‚é… Actions å…è´¹ç‰ˆ CPUï¼‰
          make package/ffmpeg/compile V=s -j2

      ###########################################################################
      # æ­¥éª¤ 8ï¼šä¸Šä¼ äº§ç‰©ï¼ˆä¸å˜ï¼‰
      ###########################################################################
      - name: ä¸Šä¼  ffmpeg äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-armv7-a5-h264
          path: |
            bin/packages/armv7/*/ffmpeg_*.ipk
            bin/packages/armv7/*/libx264_*.ipk
          retention-days: 30
